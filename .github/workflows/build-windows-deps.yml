name: Build Windows Dependencies

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 0 * * 0'  # 每周日零点触发

jobs:
  build-deps:
    runs-on: windows-latest
    timeout-minutes: 120
    defaults:
      run:
        shell: C:\cygwin64\bin\bash.exe -l -o igncr {0}

    steps:
      - uses: actions/checkout@v4

      - name: Install Cygwin
        uses: cygwin/cygwin-install-action@v4
        with:
          packages: >-
            gcc-core gcc-g++ make autoconf automake libtool pkg-config
            libfftw3-devel libsndfile-devel libgcrypt-devel libmpg123-devel
            wget git cmake
          install-dir: C:\cygwin64

      - name: Build zita-resampler
        run: |
          set -e
          cd /tmp

          # 克隆源码
          if [ ! -d "zita-resampler" ]; then
            git clone --depth 1 https://github.com/digital-stage/zita-resampler.git
          fi

          cd zita-resampler
          rm -rf build && mkdir -p build && cd build

          # Modify CMakeLists.txt to build SHARED library instead of STATIC
          sed -i 's/add_library(zita-resampler/add_library(zita-resampler SHARED/' ../CMakeLists.txt

          # CMake 配置（SHARED 库）
          cmake .. \
            -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++

          # 编译
          make -j$(nproc)

          # 安装到系统路径
          echo "=== Build artifacts ==="
          ls -lh | grep -E "(dll|a)$" || echo "No DLL/A files in build dir"

          # Copy DLL to /usr/bin
          if [ -f "cygzita-resampler.dll" ]; then
            cp cygzita-resampler.dll /usr/bin/
            echo "✓ Copied cygzita-resampler.dll"
          else
            echo "ERROR: cygzita-resampler.dll not found"
            ls -lh
            exit 1
          fi

          # Copy import library (.dll.a)
          if [ -f "libzita-resampler.dll.a" ]; then
            cp libzita-resampler.dll.a /usr/lib/
            echo "✓ Copied libzita-resampler.dll.a"
          fi

          # Copy headers
          mkdir -p /usr/include/zita-resampler
          cp ../source/zita-resampler/*.h /usr/include/zita-resampler/

          # Create pkg-config file (Name must be libzita-resampler for autotools)
          mkdir -p /usr/lib/pkgconfig
          printf 'prefix=/usr\nexec_prefix=${prefix}\nlibdir=${exec_prefix}/lib\nincludedir=${prefix}/include\n\nName: libzita-resampler\nDescription: Zita resampler library\nVersion: 1.0\nLibs: -L${libdir} -lzita-resampler\nCflags: -I${includedir}\n' > /usr/lib/pkgconfig/libzita-resampler.pc

          echo "✓ zita-resampler build success"

      - name: Verify installation
        run: |
          echo "=== Installed files ==="
          ls -lh /usr/bin/cygzita-resampler.dll
          ls -lh /usr/lib/libzita-resampler.dll.a
          ls -lh /usr/lib/pkgconfig/libzita-resampler.pc
          echo ""
          echo "=== Library check ==="
          ls -lh /usr/lib/ | grep -E "(fftw|sndfile|mpg123|gcrypt|zita)" | head -20

      - name: Create artifact
        run: |
          mkdir -p /tmp/cygwin-deps

          # Copy all essential DLLs and libs
          cp /usr/bin/cyg*.dll /tmp/cygwin-deps/ 2>/dev/null || true
          cp /usr/lib/*.dll.a /tmp/cygwin-deps/ 2>/dev/null || true
          cp -r /usr/lib/pkgconfig /tmp/cygwin-deps/
          cp -r /usr/include/zita-resampler /tmp/cygwin-deps/

          ls -lh /tmp/cygwin-deps/ | head -30

      - name: Upload dependencies artifact
        uses: actions/upload-artifact@v4
        with:
          name: cygwin-deps-x86_64
          path: /tmp/cygwin-deps/
          retention-days: 30
