name: Build audiowmark macOS ARM64

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. audiowmark-macos-2026-02-03)"
        required: true
      prerelease:
        description: "Mark as prerelease"
        type: boolean
        default: false
  push:
    branches:
      - master
    paths:
      - '.github/workflows/build-audiowmark-macos-arm.yml'

jobs:
  build-macos-arm:
    runs-on: macos-14
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install pkg-config libsndfile mpg123 fftw libgcrypt ccache autoconf automake libtool

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-macos-arm64-${{ hashFiles('.github/workflows/build-audiowmark-macos-arm.yml') }}
          restore-keys: |
            ccache-macos-arm64-

      - name: Build libzita-resampler
        run: |
          set -euo pipefail
          export CC="ccache clang"
          export CXX="ccache clang++"
          export CCACHE_DIR=~/.ccache
          mkdir -p "$CCACHE_DIR"
          ccache -M 2G

          cd /tmp
          rm -rf zita-resampler
          git clone --depth 1 https://github.com/digital-stage/zita-resampler.git
          cd zita-resampler

          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          make -j$(sysctl -n hw.ncpu)

          echo "=== Build artifacts ==="
          ls -lh | grep -E "(dylib|a)$" || echo "No dylib/a files in build dir"

          # Ensure /usr/local directories exist (macOS Sonoma+)
          sudo mkdir -p /usr/local/lib /usr/local/include /usr/local/lib/pkgconfig

          if [ -f "libzita-resampler.a" ]; then
            sudo cp libzita-resampler.a /usr/local/lib/
            echo "✓ Copied libzita-resampler.a"
          fi

          sudo mkdir -p /usr/local/include/zita-resampler
          sudo cp ../source/zita-resampler/*.h /usr/local/include/zita-resampler/

          # Create pkg-config file for static library
          printf 'prefix=/usr/local\nexec_prefix=${prefix}\nlibdir=${exec_prefix}/lib\nincludedir=${prefix}/include\n\nName: zita-resampler\nDescription: Zita resampler library\nVersion: 1.0\nLibs: -L${libdir} -lzita-resampler\nCflags: -I${includedir}\n' | sudo tee /usr/local/lib/pkgconfig/zita-resampler.pc > /dev/null

          ccache -s
          echo "✓ zita-resampler build success"

      - name: Build audiowmark
        run: |
          set -euo pipefail
          export CC="ccache clang"
          export CXX="ccache clang++"
          export CCACHE_DIR=~/.ccache
          mkdir -p "$CCACHE_DIR"
          ccache -M 2G
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          export LDFLAGS="-L/usr/local/lib"
          export CPPFLAGS="-I/usr/local/include"

          cd /tmp
          rm -rf audiowmark
          git clone --depth 1 https://github.com/swesterfeld/audiowmark.git
          cd audiowmark

          ./autogen.sh
          ./configure \
            LDFLAGS="$LDFLAGS" \
            CPPFLAGS="$CPPFLAGS"

          make -j$(sysctl -n hw.ncpu) V=1

          if [ ! -f src/audiowmark ]; then
            echo "ERROR: Binary src/audiowmark not found!"
            ls -la src/
            exit 1
          fi

          ccache -s
          echo "✓ audiowmark build success"

      - name: Collect dependencies
        run: |
          set -eo pipefail
          DIST_DIR="$GITHUB_WORKSPACE/audiowmark-dist"
          mkdir -p "$DIST_DIR/bin"

          cd /tmp/audiowmark
          if [ ! -f src/audiowmark ]; then
            echo "ERROR: src/audiowmark not found!"
            ls -la src/
            exit 1
          fi
          cp src/audiowmark "$DIST_DIR/bin/"
          echo "✓ Copied audiowmark binary"

          cd "$DIST_DIR/bin"
          echo ""
          echo "=== Binary dependencies ==="
          otool -L audiowmark || true

          echo ""
          echo "=== Collecting dylib dependencies ==="
          # Collect from /opt/homebrew (Apple Silicon Homebrew location)
          DYLIBS=$(otool -L audiowmark | grep -E "(/usr/local|/opt/homebrew)" | awk '{print $1}' | sort -u) || true

          if [ -z "$DYLIBS" ]; then
            echo "No custom dylibs found (all deps likely from system)"
          else
            for dylib in $DYLIBS; do
              if [ -f "$dylib" ]; then
                cp "$dylib" .
                echo "  ✓ $(basename $dylib)"
              else
                echo "  ✗ Not found: $dylib"
              fi
            done
          fi

          echo ""
          echo "=== Distribution contents ==="
          ls -lh
          echo "Total files: $(find . -type f | wc -l)"

      - name: Test in clean environment (no system libraries)
        run: |
          set -euo pipefail
          DIST_DIR="$GITHUB_WORKSPACE/audiowmark-dist"

          cd "$DIST_DIR/bin"
          echo "=== Testing in isolated environment ==="
          echo "Clearing DYLD_LIBRARY_PATH to test bundled dependencies..."

          # Test with only bundled libraries
          unset DYLD_LIBRARY_PATH || true
          export DYLD_LIBRARY_PATH="$DIST_DIR/bin"

          echo "Testing: ./audiowmark --version"
          if ./audiowmark --version; then
            echo "✓ Binary works with bundled dependencies"
          else
            echo "✗ FAILED: Binary doesn't work with only bundled dependencies"
            echo "Missing dependencies or incompatible versions"
            exit 1
          fi

          echo ""
          echo "Testing: ./audiowmark gen-key"
          if ./audiowmark gen-key test.key; then
            echo "✓ Key generation works"
          else
            echo "✗ FAILED: Key generation failed"
            exit 1
          fi

          echo ""
          echo "✓ All tests passed - distribution is self-contained"

      - name: Verify functionality with system libraries
        run: |
          set -euo pipefail
          DIST_DIR="$GITHUB_WORKSPACE/audiowmark-dist"
          export DYLD_LIBRARY_PATH="$DIST_DIR/bin:${DYLD_LIBRARY_PATH:-}"

          cd "$DIST_DIR/bin"
          echo "=== Verify with system libraries available ==="
          ./audiowmark --version
          echo "✓ All functionality verified"

      - name: Package artifact
        run: |
          set -euo pipefail
          DIST_DIR="$GITHUB_WORKSPACE/audiowmark-dist"
          cd "$(dirname $DIST_DIR)"
          tar -czf "$GITHUB_WORKSPACE/audiowmark-macos-arm64.tar.gz" "$(basename $DIST_DIR)"
          echo "Package size: $(du -h $GITHUB_WORKSPACE/audiowmark-macos-arm64.tar.gz | awk '{print $1}')"

      - name: Ensure tag exists
        if: github.event_name == 'workflow_dispatch'
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag }}"
          git fetch --tags --force 2>/dev/null || true
          if ! git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
            git tag "$TAG" "$GITHUB_SHA"
            git push origin "$TAG"
          fi

      - name: Create GitHub release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag }}
          name: ${{ inputs.tag }}
          prerelease: ${{ inputs.prerelease }}
          files: ${{ github.workspace }}/audiowmark-macos-arm64.tar.gz

      - name: Upload artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: audiowmark-macos-arm64
          path: audiowmark-dist/
          retention-days: 30
