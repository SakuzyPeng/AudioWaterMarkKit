name: Build awmkit CLI

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., awmkit-0.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'awmkit-*'

permissions:
  contents: write

env:
  FFMPEG_MACOS_RELEASE: ffmpeg-runtime-8.0.2
  FFMPEG_MACOS_ASSET: ffmpeg-macos-arm64-gpl-slim-runtime-8.0.2.zip
  FFMPEG_WINDOWS_RELEASE: ffmpeg-runtime-8.0.2
  FFMPEG_WINDOWS_ASSET: ffmpeg-win64-gpl-slim-runtime-8.0.2.zip

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            audiowmark_asset: audiowmark-macos-arm64.tar.gz
            audiowmark_release: audiowmark-macos-arm64-2026-02-03
            ffmpeg_asset: ffmpeg-macos-arm64-gpl-slim-runtime-8.0.2.zip
            ffmpeg_release: ffmpeg-runtime-8.0.2
            output_name: awmkit-macos-arm64
            output_ext: tar.gz

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            audiowmark_asset: audiowmark-windows-x86_64.zip
            audiowmark_release: audiowmark-win-2026-02-03
            ffmpeg_asset: ffmpeg-win64-gpl-slim-runtime-8.0.2.zip
            ffmpeg_release: ffmpeg-runtime-8.0.2
            output_name: awmkit-windows-x86_64
            output_ext: zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Download audiowmark release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          gh release download "${{ matrix.audiowmark_release }}" --repo "${{ github.repository }}" -p "${{ matrix.audiowmark_asset }}"

      - name: Download FFmpeg release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          gh release download "${{ matrix.ffmpeg_release }}" --repo "${{ github.repository }}" -p "${{ matrix.ffmpeg_asset }}"

      - name: Prepare bundled audiowmark (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p bundled
          tar -xzf ${{ matrix.audiowmark_asset }}
          rm -f audiowmark-dist/bin/test.key
          cd audiowmark-dist
          zip -r "$GITHUB_WORKSPACE/bundled/audiowmark-macos-arm64.zip" bin
          cd "$GITHUB_WORKSPACE"
          ls -lh bundled/audiowmark-macos-arm64.zip

      - name: Prepare FFmpeg runtime (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          ASSET="${{ matrix.ffmpeg_asset }}"
          mkdir -p ffmpeg-dist
          unzip -q "$ASSET" -d ffmpeg-dist
          ROOT="$(find ffmpeg-dist -mindepth 1 -maxdepth 1 -type d | head -n 1)"
          test -n "$ROOT"
          if [ -d "$ROOT/lib" ]; then
            cp -a "$ROOT/lib" ffmpeg-dist/
          elif [ -d "$ROOT/bin" ]; then
            mkdir -p ffmpeg-dist/lib
            cp -a "$ROOT/bin/"*.dylib ffmpeg-dist/lib/
          else
            echo "Invalid ffmpeg package: missing lib/bin directory" >&2
            exit 1
          fi
          test -d ffmpeg-dist/lib
          ls ffmpeg-dist/lib/libavcodec*.dylib >/dev/null
          ls ffmpeg-dist/lib/libavformat*.dylib >/dev/null
          ls ffmpeg-dist/lib/libavutil*.dylib >/dev/null
          ls ffmpeg-dist/lib/libavfilter*.dylib >/dev/null
          ls ffmpeg-dist/lib/libswresample*.dylib >/dev/null
          FF_ASSET="$ASSET" python3 - <<'PY'
          import json, pathlib, hashlib
          import os
          manifest = json.loads(pathlib.Path("tools/ffmpeg/manifest.json").read_text())
          expected = manifest["assets"]["macos_arm64"]["sha256"].strip()
          if expected:
              data = pathlib.Path(os.environ["FF_ASSET"]).read_bytes()
              actual = hashlib.sha256(data).hexdigest()
              if actual.lower() != expected.lower():
                  raise SystemExit(f"sha256 mismatch: {actual} != {expected}")
          print("ffmpeg asset sha256 check passed (or skipped when empty).")
          PY
          echo "FFMPEG_DIR=$GITHUB_WORKSPACE/ffmpeg-dist" >> "$GITHUB_ENV"
          echo "DYLD_FALLBACK_LIBRARY_PATH=$GITHUB_WORKSPACE/ffmpeg-dist/lib" >> "$GITHUB_ENV"

      - name: Prepare bundled audiowmark (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p bundled
          cp "${{ matrix.audiowmark_asset }}" bundled/audiowmark-windows-x86_64.zip
          ls -lh bundled/audiowmark-windows-x86_64.zip

      - name: Prepare FFmpeg runtime (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ffmpeg-dist | Out-Null
          Expand-Archive -Path "${{ matrix.ffmpeg_asset }}" -DestinationPath ffmpeg-dist -Force
          $root = Get-ChildItem -Path ffmpeg-dist -Directory | Select-Object -First 1
          if ($null -eq $root) {
            throw "Invalid ffmpeg package: missing root directory."
          }
          if (Test-Path (Join-Path $root.FullName "lib")) {
            Copy-Item (Join-Path $root.FullName "lib") ffmpeg-dist -Recurse -Force
          } elseif (Test-Path (Join-Path $root.FullName "bin")) {
            New-Item -ItemType Directory -Force -Path ffmpeg-dist\lib | Out-Null
            Copy-Item (Join-Path $root.FullName "bin\\*.dll") ffmpeg-dist\lib -Force
          } else {
            throw "Invalid ffmpeg package: missing lib/bin directory."
          }
          if (!(Test-Path "ffmpeg-dist/lib/avcodec-62.dll")) { throw "Missing avcodec-62.dll in ffmpeg package." }
          if (!(Test-Path "ffmpeg-dist/lib/avformat-62.dll")) { throw "Missing avformat-62.dll in ffmpeg package." }
          if (!(Test-Path "ffmpeg-dist/lib/avutil-60.dll")) { throw "Missing avutil-60.dll in ffmpeg package." }
          if (!(Test-Path "ffmpeg-dist/lib/avfilter-11.dll")) { throw "Missing avfilter-11.dll in ffmpeg package." }
          if (!(Test-Path "ffmpeg-dist/lib/swresample-6.dll")) { throw "Missing swresample-6.dll in ffmpeg package." }
          $manifest = Get-Content tools/ffmpeg/manifest.json -Raw | ConvertFrom-Json
          $expected = "$($manifest.assets.windows_x86_64.sha256)".Trim()
          if ($expected.Length -gt 0) {
            $actual = (Get-FileHash -Algorithm SHA256 "${{ matrix.ffmpeg_asset }}").Hash.ToLowerInvariant()
            if ($actual -ne $expected.ToLowerInvariant()) {
              throw "sha256 mismatch: $actual != $expected"
            }
          }
          "FFMPEG_DIR=$env:GITHUB_WORKSPACE\\ffmpeg-dist" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$env:GITHUB_WORKSPACE\\ffmpeg-dist\\lib" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build awmkit
        run: cargo build --bin awmkit --features full-cli,bundled --release --target ${{ matrix.target }}

      - name: Verify build (macOS)
        if: runner.os == 'macOS'
        run: |
          ls -lh target/${{ matrix.target }}/release/awmkit
          file target/${{ matrix.target }}/release/awmkit
          target/${{ matrix.target }}/release/awmkit --version

      - name: Verify build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Get-ChildItem target/${{ matrix.target }}/release/awmkit.exe
          target/${{ matrix.target }}/release/awmkit.exe --version

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p pkg/lib/ffmpeg
          cp target/${{ matrix.target }}/release/awmkit pkg/
          cp ffmpeg-dist/lib/*.dylib pkg/lib/ffmpeg/
          tar -czf ${{ matrix.output_name }}.tar.gz -C pkg .
          ls -lh ${{ matrix.output_name }}.tar.gz
          shasum -a 256 ${{ matrix.output_name }}.tar.gz

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path pkg\lib\ffmpeg | Out-Null
          Copy-Item target/${{ matrix.target }}/release/awmkit.exe pkg\ -Force
          Copy-Item ffmpeg-dist\lib\*.dll pkg\lib\ffmpeg\ -Force
          Compress-Archive -Path pkg\* -DestinationPath ${{ matrix.output_name }}.zip -Force
          Get-ChildItem ${{ matrix.output_name }}.zip
          Get-FileHash -Algorithm SHA256 ${{ matrix.output_name }}.zip

      - name: Determine release tag
        id: tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          prerelease: ${{ inputs.prerelease || false }}
          body_path: docs/AWMKIT_RELEASE_NOTES.md
          files: |
            ${{ matrix.output_name }}.${{ matrix.output_ext }}
          token: ${{ secrets.GITHUB_TOKEN }}
