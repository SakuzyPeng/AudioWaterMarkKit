name: Build awmkit CLI

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., awmkit-0.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'awmkit-*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            audiowmark_asset: audiowmark-macos-arm64.tar.gz
            audiowmark_release: audiowmark-macos-arm64-2026-02-03
            output_name: awmkit-macos-arm64
            output_ext: tar.gz

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            audiowmark_asset: audiowmark-windows-x86_64.zip
            audiowmark_release: audiowmark-win-2026-02-03
            output_name: awmkit-windows-x86_64
            output_ext: zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Download audiowmark release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          gh release download "${{ matrix.audiowmark_release }}" --repo "${{ github.repository }}" -p "${{ matrix.audiowmark_asset }}"

      - name: Prepare bundled audiowmark (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p bundled
          tar -xzf ${{ matrix.audiowmark_asset }}
          rm -f audiowmark-dist/bin/test.key
          cd audiowmark-dist
          zip -r "$GITHUB_WORKSPACE/bundled/audiowmark-macos-arm64.zip" bin
          cd "$GITHUB_WORKSPACE"
          ls -lh bundled/audiowmark-macos-arm64.zip

      - name: Prepare bundled audiowmark (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p bundled
          cp "${{ matrix.audiowmark_asset }}" bundled/audiowmark-windows-x86_64.zip
          ls -lh bundled/audiowmark-windows-x86_64.zip

      - name: Build awmkit
        run: cargo build --bin awmkit --features full-cli,bundled --release --target ${{ matrix.target }}

      - name: Verify build (macOS)
        if: runner.os == 'macOS'
        run: |
          ls -lh target/${{ matrix.target }}/release/awmkit
          file target/${{ matrix.target }}/release/awmkit
          target/${{ matrix.target }}/release/awmkit --version

      - name: Verify build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Get-ChildItem target/${{ matrix.target }}/release/awmkit.exe
          target/${{ matrix.target }}/release/awmkit.exe --version

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          tar -czf ${{ matrix.output_name }}.tar.gz -C target/${{ matrix.target }}/release awmkit
          ls -lh ${{ matrix.output_name }}.tar.gz
          shasum -a 256 ${{ matrix.output_name }}.tar.gz

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path target/${{ matrix.target }}/release/awmkit.exe -DestinationPath ${{ matrix.output_name }}.zip -Force
          Get-ChildItem ${{ matrix.output_name }}.zip
          Get-FileHash -Algorithm SHA256 ${{ matrix.output_name }}.zip

      - name: Determine release tag
        id: tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          prerelease: ${{ inputs.prerelease || false }}
          body_path: docs/AWMKIT_RELEASE_NOTES.md
          files: |
            ${{ matrix.output_name }}.${{ matrix.output_ext }}
            ${{ matrix.gui_output_name }}.${{ matrix.gui_output_ext }}
          token: ${{ secrets.GITHUB_TOKEN }}
