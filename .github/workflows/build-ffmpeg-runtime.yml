name: Build FFmpeg Runtime

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (e.g. ffmpeg-runtime-8.0.2)"
        required: true
        default: "ffmpeg-runtime-8.0.1"
      ffmpeg_ref:
        description: "FFmpeg git ref/tag (e.g. n8.0.2)"
        required: true
        default: "n8.0.1"
      version_tag:
        description: "Asset version suffix (e.g. 8.0.2)"
        required: true
        default: "8.0.1"
      btbn_windows_release:
        description: "BtbN release tag for prebuilt Windows package"
        required: true
        default: "latest"
      btbn_windows_asset:
        description: "BtbN Windows shared package asset name"
        required: true
        default: "ffmpeg-n8.0-latest-win64-gpl-shared-8.0.zip"
      prerelease:
        description: "Mark release as prerelease"
        type: boolean
        required: false
        default: true
      publish_release:
        description: "Publish assets to GitHub Release"
        type: boolean
        required: false
        default: true

permissions:
  contents: write

jobs:
  build-macos-arm64:
    name: Build FFmpeg macOS arm64 runtime
    runs-on: macos-14
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew update
          brew install pkg-config nasm yasm

      - name: Clone FFmpeg source (shallow)
        run: |
          rm -rf "$RUNNER_TEMP/ffmpeg-src"
          git clone --depth 1 --branch "${{ inputs.ffmpeg_ref }}" https://github.com/FFmpeg/FFmpeg.git "$RUNNER_TEMP/ffmpeg-src" || \
            (echo "Invalid ffmpeg_ref: ${{ inputs.ffmpeg_ref }}. Try n8.0.1 or n8.0." >&2; exit 1)
          git -C "$RUNNER_TEMP/ffmpeg-src" rev-parse HEAD

      - name: Build slim runtime
        run: |
          VERSION_TAG="${{ inputs.version_tag }}" \
          bash "$GITHUB_WORKSPACE/tools/ffmpeg/build-macos-arm64.sh" "$RUNNER_TEMP/ffmpeg-src"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-arm64-runtime
          path: |
            dist/ffmpeg-macos-arm64-gpl-slim-runtime/*.zip
            dist/ffmpeg-macos-arm64-gpl-slim-runtime/*.zip.sha256

  build-windows-x64:
    name: Repackage FFmpeg Windows x64 runtime (BtbN prebuilt)
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download BtbN FFmpeg package
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "${{ inputs.btbn_windows_release }}" `
            --repo "BtbN/FFmpeg-Builds" `
            -p "${{ inputs.btbn_windows_asset }}" `
            --clobber
          if (!(Test-Path "${{ inputs.btbn_windows_asset }}")) {
            throw "Failed to download BtbN asset: ${{ inputs.btbn_windows_asset }}"
          }

      - name: Repackage slim runtime asset
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $asset = "${{ inputs.btbn_windows_asset }}"
          $extractDir = Join-Path $env:RUNNER_TEMP "ffmpeg-btbn"
          Remove-Item -Recurse -Force $extractDir -ErrorAction SilentlyContinue
          Expand-Archive -Path $asset -DestinationPath $extractDir -Force

          $root = Get-ChildItem -Path $extractDir -Directory | Select-Object -First 1
          if ($null -eq $root) {
            throw "Invalid BtbN package: missing root directory"
          }

          $binDir = Join-Path $root.FullName "bin"
          if (!(Test-Path $binDir)) {
            throw "Invalid BtbN package: missing bin directory"
          }

          foreach ($required in @("avcodec-*.dll","avformat-*.dll","avutil-*.dll","avfilter-*.dll","swresample-*.dll")) {
            if (!(Get-ChildItem -Path $binDir -Filter $required -ErrorAction SilentlyContinue)) {
              throw "Missing required runtime library pattern: $required"
            }
          }

          $outDir = "dist/ffmpeg-win64-gpl-slim-runtime"
          $pkgName = "ffmpeg-win64-gpl-slim-runtime-${{ inputs.version_tag }}"
          $pkgRoot = Join-Path $outDir $pkgName
          $pkgBin = Join-Path $pkgRoot "bin"

          Remove-Item -Recurse -Force $outDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $pkgBin | Out-Null

          Copy-Item (Join-Path $binDir "avcodec-*.dll") $pkgBin -Force
          Copy-Item (Join-Path $binDir "avformat-*.dll") $pkgBin -Force
          Copy-Item (Join-Path $binDir "avutil-*.dll") $pkgBin -Force
          Copy-Item (Join-Path $binDir "avfilter-*.dll") $pkgBin -Force
          Copy-Item (Join-Path $binDir "swresample-*.dll") $pkgBin -Force

          $licenseCandidates = Get-ChildItem -Path $root.FullName -File -Include "LICENSE*","COPYING*" -ErrorAction SilentlyContinue
          if ($licenseCandidates.Count -gt 0) {
            Copy-Item $licenseCandidates[0].FullName (Join-Path $pkgRoot "LICENSE.GPL.txt") -Force
          } else {
            "FFmpeg license text not found in source package." | Set-Content (Join-Path $pkgRoot "LICENSE.GPL.txt") -Encoding UTF8
          }

          @"
AWMKit FFmpeg runtime (Windows x64)
Version: ${{ inputs.version_tag }}
Source: BtbN/FFmpeg-Builds (${{ inputs.btbn_windows_asset }})
This package contains slim shared libraries required by AWMKit runtime.
Included libraries: avcodec, avformat, avutil, avfilter, swresample.
"@ | Set-Content (Join-Path $pkgRoot "README.txt") -Encoding UTF8

          $zipPath = Join-Path $outDir "$pkgName.zip"
          Compress-Archive -Path "$pkgRoot\\*" -DestinationPath $zipPath -Force
          $hash = (Get-FileHash -Algorithm SHA256 $zipPath).Hash.ToLowerInvariant()
          "$hash  $pkgName.zip" | Set-Content (Join-Path $outDir "$pkgName.zip.sha256") -Encoding UTF8
          Get-Item $zipPath
          Get-Item (Join-Path $outDir "$pkgName.zip.sha256")

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-windows-x64-runtime
          path: |
            dist/ffmpeg-win64-gpl-slim-runtime/*.zip
            dist/ffmpeg-win64-gpl-slim-runtime/*.zip.sha256

  release:
    name: Publish FFmpeg Runtime Release
    runs-on: ubuntu-latest
    needs:
      - build-macos-arm64
      - build-windows-x64
    if: ${{ inputs.publish_release }}

    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-macos-arm64-runtime
          path: dist-release

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-windows-x64-runtime
          path: dist-release

      - name: List release payload
        run: |
          ls -lh dist-release

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_tag }}
          prerelease: ${{ inputs.prerelease }}
          files: |
            dist-release/*.zip
            dist-release/*.zip.sha256
