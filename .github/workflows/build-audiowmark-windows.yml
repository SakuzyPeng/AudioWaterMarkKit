name: Build audiowmark Windows

on:
  push:
    branches: [main, master]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120
    defaults:
      run:
        shell: C:\cygwin64\bin\bash.exe -l -o igncr {0}

    steps:
      - uses: actions/checkout@v4

      - name: Install Cygwin
        uses: cygwin/cygwin-install-action@v4
        with:
          packages: >-
            gcc-core gcc-g++ make autoconf automake libtool pkg-config
            libfftw3-devel libsndfile-devel libgcrypt-devel libmpg123-devel
            wget git cmake
          install-dir: C:\cygwin64

      - name: Cache zita-resampler build
        uses: actions/cache@v4
        id: zita_cache
        with:
          path: |
            /usr/lib/libzita-resampler*
            /usr/lib/pkgconfig/zita-resampler.pc
            /usr/include/zita-resampler
            /usr/bin/cygzita-resampler.dll
          key: zita-resampler-${{ hashFiles('.github/workflows/build-audiowmark-windows.yml') }}
          restore-keys: zita-resampler-

      - name: Build zita-resampler
        if: steps.zita_cache.outputs.cache-hit != 'true'
        run: |
          set -e
          cd /tmp
          git clone --depth 1 https://github.com/digital-stage/zita-resampler.git
          cd zita-resampler

          # Modify CMakeLists.txt to build SHARED library instead of STATIC
          sed -i 's/add_library(zita-resampler/add_library(zita-resampler SHARED/' CMakeLists.txt

          mkdir -p build && cd build
          cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

          # Install to system paths
          echo "=== Build artifacts ==="
          ls -lh | grep -E "(dll|a)$" || echo "No DLL/A files in build dir"

          # Copy DLL to /usr/bin
          if [ -f "cygzita-resampler.dll" ]; then
            cp cygzita-resampler.dll /usr/bin/
            echo "✓ Copied cygzita-resampler.dll"
          else
            echo "ERROR: cygzita-resampler.dll not found"
            ls -lh
            exit 1
          fi

          # Copy import library (.dll.a)
          if [ -f "libzita-resampler.dll.a" ]; then
            cp libzita-resampler.dll.a /usr/lib/
            echo "✓ Copied libzita-resampler.dll.a"
          fi

          # Copy headers
          mkdir -p /usr/include/zita-resampler
          cp ../source/zita-resampler/*.h /usr/include/zita-resampler/

          # Create pkg-config file
          mkdir -p /usr/lib/pkgconfig
          printf 'prefix=/usr\nexec_prefix=${prefix}\nlibdir=${exec_prefix}/lib\nincludedir=${prefix}/include\n\nName: zita-resampler\nDescription: Zita resampler library\nVersion: 1.0\nLibs: -L${libdir} -lzita-resampler\nCflags: -I${includedir}\n' > /usr/lib/pkgconfig/zita-resampler.pc

          echo "✓ zita-resampler build success"

      - name: Verify zita-resampler
        run: |
          ls -lh /usr/bin/cygzita-resampler.dll 2>/dev/null && echo "✓ zita-resampler DLL found" || echo "⚠ zita-resampler DLL not found"

      - name: Verify libraries before build
        run: |
          echo "=== Checking library files ==="
          ls -lh /usr/lib/ | grep -E "(fftw|sndfile|mpg123|gcrypt|zita)" | head -20
          echo ""
          ls -lh /usr/lib/*.dll.a 2>/dev/null | wc -l
          echo "Total import libraries (.dll.a) in /usr/lib"

      - name: Build audiowmark
        run: |
          set -e
          export PATH="/usr/bin:$PATH"
          export PKG_CONFIG_PATH="/usr/lib/pkgconfig:/usr/share/pkgconfig"
          export LDFLAGS="-L/usr/lib"
          export CPPFLAGS="-I/usr/include"
          cd /tmp
          git clone --depth 1 https://github.com/swesterfeld/audiowmark.git
          cd audiowmark
          sed -i '1i#define _GNU_SOURCE' src/utils.cc
          ./autogen.sh

          # Try without --host first (native compilation on Cygwin)
          ./configure LDFLAGS="$LDFLAGS" CPPFLAGS="$CPPFLAGS" || ./configure --host=x86_64-pc-cygwin LDFLAGS="$LDFLAGS" CPPFLAGS="$CPPFLAGS"

          # Build with verbose output to see full link commands
          make -j1 V=1

          # Check if binary was created
          if [ ! -f src/audiowmark.exe ]; then
            echo "ERROR: audiowmark.exe not found!"
            ls -la src/
            exit 1
          fi

          ./src/audiowmark.exe --version || ./src/audiowmark --version || true
          echo "✓ audiowmark build success"

      - name: Collect dependencies
        run: |
          set -e
          export PATH="/usr/bin:$PATH"
          cd /tmp/audiowmark
          mkdir -p /tmp/audiowmark-dist/bin
          cp src/audiowmark.exe /tmp/audiowmark-dist/bin/

          # 诊断：输出 ldd 的实际内容
          echo "=== LDD output ==="
          ldd src/audiowmark.exe || true
          echo "=== End LDD ==="

          # 方法 1: 从 ldd 输出提取 DLL 路径（支持多种格式）
          ldd src/audiowmark.exe 2>/dev/null | grep -oE '(/[^ ]*\.dll|/[^ ]*\.so(\.[0-9]+)?)' | sort -u | while read dll; do
            if [ -f "$dll" ]; then
              echo "Copying: $dll"
              cp "$dll" /tmp/audiowmark-dist/bin/ 2>/dev/null || true
            fi
          done

          # 方法 2: 手动复制常见的 Cygwin DLL
          echo "Copying standard Cygwin libraries..."
          for dll in \
            /usr/bin/cygwin1.dll \
            /usr/bin/cyggcc_s-seh-1.dll \
            /usr/bin/cygstdc++-6.dll \
            /usr/bin/cygfftw3f-3.dll \
            /usr/bin/cygsndfile-1.dll \
            /usr/bin/cygmpg123-0.dll \
            /usr/bin/cyggcrypt-20.dll \
            /usr/bin/cyggpg-error-0.dll \
            /usr/bin/cygz.dll \
            /usr/bin/cygFLAC.dll \
            /usr/bin/cygogg.dll \
            /usr/bin/cygvorbis.dll \
            /usr/bin/cygvorbisenc.dll \
            /usr/bin/cygzita-resampler.dll
          do
            if [ -f "$dll" ]; then
              cp "$dll" /tmp/audiowmark-dist/bin/ 2>/dev/null || true
            fi
          done

          # 显示收集结果
          echo ""
          echo "Collected DLLs:"
          ls -lh /tmp/audiowmark-dist/bin/*.dll 2>/dev/null | wc -l
          ls -lh /tmp/audiowmark-dist/bin/
          echo "✓ Dependencies collected"

      - name: Verify functionality
        run: |
          set -e
          export PATH="/tmp/audiowmark-dist/bin:/usr/bin:$PATH"
          export LD_LIBRARY_PATH="/tmp/audiowmark-dist/bin:/usr/lib:$LD_LIBRARY_PATH"

          cd /tmp/audiowmark-dist/bin

          echo "=== Environment ==="
          echo "PATH=$PATH"
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
          echo ""

          echo "=== Files in bin directory ==="
          ls -lh
          echo ""

          echo "=== Running audiowmark ==="
          ./audiowmark.exe --version 2>&1 || (echo "Failed to run audiowmark.exe"; file ./audiowmark.exe; ldd ./audiowmark.exe; exit 1)
          ./audiowmark.exe gen-key test.key
          echo "✓ Audiowmark binary verified"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audiowmark-windows-x86_64
          path: /tmp/audiowmark-dist/
          retention-days: 30
