name: Build audiowmark Windows

on:
  push:
    branches: [main, master]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120
    defaults:
      run:
        shell: C:\cygwin64\bin\bash.exe -l -o igncr {0}

    steps:
      - uses: actions/checkout@v4

      - name: Install Cygwin
        uses: cygwin/cygwin-install-action@v4
        with:
          packages: >-
            gcc-core gcc-g++ make autoconf automake libtool pkg-config
            libfftw3-devel libsndfile-devel libgcrypt-devel libmpg123-devel
            wget git cmake
          install-dir: C:\cygwin64

      - name: Build zita-resampler
        run: |
          set -e
          cd /tmp
          git clone --depth 1 https://github.com/digital-stage/zita-resampler.git
          cd zita-resampler
          mkdir -p build && cd build
          cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          cp libzita-resampler.dll /usr/bin/
          cp libzita-resampler.dll.a /usr/lib/
          mkdir -p /usr/include/zita-resampler
          cp ../source/zita-resampler/*.h /usr/include/zita-resampler/
          echo "✓ zita-resampler build success"

      - name: Build audiowmark
        run: |
          set -e
          cd /tmp
          git clone --depth 1 https://github.com/swesterfeld/audiowmark.git
          cd audiowmark
          sed -i '1i#define _GNU_SOURCE' src/utils.cc
          ./autogen.sh
          ./configure --host=x86_64-pc-cygwin
          make -j$(nproc)
          ./src/audiowmark --version
          echo "✓ audiowmark build success"

      - name: Collect dependencies
        run: |
          set -e
          cd /tmp/audiowmark
          mkdir -p /tmp/audiowmark-dist/bin
          cp src/audiowmark.exe /tmp/audiowmark-dist/bin/
          ldd src/audiowmark.exe | grep -o '/usr/bin/[^ ]*\.dll' | sort -u | while read dll; do
            cp "$dll" /tmp/audiowmark-dist/bin/ 2>/dev/null || true
          done
          cp /usr/bin/cygwin1.dll /tmp/audiowmark-dist/bin/ 2>/dev/null || true
          ls -lh /tmp/audiowmark-dist/bin/*.dll | wc -l
          echo "✓ Dependencies collected"

      - name: Verify functionality
        run: |
          set -e
          cd /tmp/audiowmark-dist/bin
          ./audiowmark.exe --version
          ./audiowmark.exe gen-key test.key
          echo "✓ Audiowmark binary verified"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audiowmark-windows-x86_64
          path: /tmp/audiowmark-dist/
          retention-days: 30
