# AWMKit 鲁棒性实验

本文档记录 AWMKit 水印在各种音频处理场景下的鲁棒性测试结果。

## 测试环境

- **水印引擎**: audiowmark (基于扩频技术)
- **默认强度**: strength=10
- **消息格式**: 128-bit (HMAC-48 认证)
- **测试日期**: 2026-01

---

## 1. 有损压缩测试

### 1.1 AAC 压缩 (strength vs 检测置信度)

测试条件：120s 切片 + AAC 64kbps

| strength | 检测率 | 置信度 | SNR (dB) | 评价 |
|----------|--------|--------|----------|------|
| 4 | 100% | 0.40 | 48.8 | 置信度不足 |
| 5 | 100% | 0.48 | 46.8 | 置信度不足 |
| 6 | 100% | 0.57 | 45.3 | 勉强可用 |
| 7 | 100% | 0.67 | 43.9 | 勉强可用 |
| **8** | **100%** | **0.76** | **42.8** | 偏重音质 |
| **9** | **100%** | **0.86** | **41.8** | 平衡 |
| **10** | **100%** | **0.96** | **40.8** | **推荐** |
| 11 | 100% | 1.05 | 40.0 | 高鲁棒 |
| 12 | 100% | 1.14 | 39.3 | 高鲁棒 |
| 15 | 100% | 1.37 | 37.9 | 高鲁棒 |
| 20 | 100% | 1.85 | 34.9 | 极高鲁棒 |

### 1.2 切片时长影响 (strength=10, AAC 64k)

| 切片时长 | 检测率 | 置信度 |
|----------|--------|--------|
| 30s | 100% | 0.92 |
| 45s | 100% | 0.92 |
| 60s | 100% | 0.93 |
| 90s | 100% | 0.91 |
| 120s | 100% | 0.94 |

**结论**: 30s 以上切片均可 100% 检测。

---

## 2. 声道处理测试

### 2.1 下混测试 (多声道 → 立体声)

测试文件：8ch 7.1 → 2ch stereo

| 处理方式 | 结果 |
|----------|------|
| afconvert 下混 | ✓ 检测成功 |
| ffmpeg downmix | ✓ 检测成功 |

### 2.2 上混测试 (立体声 → 多声道)

测试流程：8ch → 下混 2ch → 加水印 → 上混 7.1

| 步骤 | 文件 | 状态 |
|------|------|------|
| 原始 2ch (下混后) | test_2ch.wav | 无水印 |
| 加水印后 | test_2ch_wm.wav | ✓ FTSC |
| 上混 7.1 | test_upmix_7.1.wav | ✓ FTSC |

**结论**: 水印对上混操作（声道复制）具有鲁棒性。

### 2.3 HRTF/双耳处理测试

测试：多声道水印音频经过 HRTF 处理后能否检测

| 处理方式 | 结果 |
|----------|------|
| ffmpeg earwax (HRTF 模拟) | ✓ 检测成功 |
| macOS Spatial Mixer (真实 HRTF + SOFA) | ✓ 检测成功 |

**结论**: 水印对 HRTF 双耳化处理具有鲁棒性。

---

## 3. 音频叠加测试

测试：将水印音频与另一段音频混合后能否检测

### 3.1 测试配置

- 水印音频：test_2ch_wm.wav (流行乐)
- 叠加音频：Debussy - Clair de lune (钢琴独奏)
- 混音方式：ffmpeg amix

### 3.2 不同混音比例测试

| 混音比例 (水印:叠加) | 结果 | 备注 |
|----------------------|------|------|
| 1:0.5 | ✓ 通过 | 叠加音量 50% |
| 1:1 | ✓ 通过 | 等音量混合 |
| 1:2 | ✓ 通过 | 叠加音量 200% |
| 1:4 | ✓ 通过 | 叠加音量 400% |

### 3.3 高响度音频叠加测试

叠加音频：-4.5 LUFS, True Peak +9.0 dBFS (严重削波)

| 混音比例 | 结果 |
|----------|------|
| 1:1 | ✓ 通过 |

**结论**: 水印对音频叠加/混音具有极强鲁棒性，即使叠加高响度削波音频也能检测。

---

## 4. 误报率测试

对无水印音频进行检测：

| 音频类型 | 最高置信度 | 目标消息匹配 |
|----------|------------|--------------|
| 无水印 (AAC 64k) | 0.26 | 无 |
| 有水印 (s=10, AAC 64k) | 0.91 | 有 |

- **区分比**: 3.5x (0.91 / 0.26)
- **推荐阈值**: 0.5 (误报率 ≈ 0%)

---

## 5. 消息格式测试

测试不同 128-bit 消息的兼容性：

| 消息 (hex) | 无压缩 | AAC 64k |
|------------|--------|---------|
| `deadbeefcafebabe...` | 1.39 | 0.96 |
| `aaaaaaaaaaaaaaaa...` | 1.39 | 0.92 |
| `0123456789abcdef...` | 1.39 | 0.91 |
| `00000000000000000...` | 1.39 | 0.94 |
| `ffffffffffffffff...` | 1.39 | 0.92 |

**结论**: 任意 128-bit 消息均可正常工作。

---

## 6. 多水印叠加测试

对同一音频依次嵌入 5 个不同水印：

| 嵌入顺序 | 无压缩检测 | AAC 64k 检测 |
|----------|------------|--------------|
| M1 (第一个) | ✗ | ✗ |
| M2 | ✓ 6.82 | ✓ 4.56 |
| M3 | ✓ 7.04 | ✓ 4.37 |
| M4 | ✗ | ✗ |
| M5 (最后) | ✓ 6.67 | ✓ 4.42 |

**结论**: 多水印会相互干扰，仅部分可检测 (3/5)。audiowmark 设计为单水印使用。

---

## 7. 多声道检测结果

以 7.1.4 (12ch) 为例：

| 声道对 | 置信度 | 说明 |
|--------|--------|------|
| FL+FR | 1.39 | ✓ 主声道，最佳 |
| FC+LFE | 0.45 | ⚠ 中置+低音炮 |
| BL+BR | 1.35 | ✓ 后置环绕 |
| SL+SR | 1.38 | ✓ 侧环绕 |
| TFL+TFR | 1.36 | ✓ 顶部前置 |
| TBL+TBR | 1.34 | ✓ 顶部后置 |

**说明**: FC+LFE 因内容特性置信度较低，但不影响整体检测。

---

## 8. 音频变换测试

批量测试 30 种音频变换对水印的影响。

### 8.1 测试结果汇总

| 类别 | 变换 | 结果 |
|------|------|------|
| **位深转换** | 24bit → 16bit | ✓ 通过 |
| | 24bit → 32bit | ✓ 通过 |
| **动态处理** | 轻度压缩 (threshold=-20dB, ratio=4) | ✓ 通过 |
| | 重度压缩 (threshold=-10dB, ratio=10) | ✓ 通过 |
| | 限制器 (limit=0.8) | ✓ 通过 |
| **裁剪** | 截取 30s 片段 | ✓ 通过 |
| | 截取 60s 片段 | ✓ 通过 |
| **回声/混响** | 短回声 (60ms delay) | ✓ 通过 |
| | 长回声 (500ms delay) | ✓ 通过 |
| **均衡器** | 高通滤波 (200Hz) | ✓ 通过 |
| | 低通滤波 (8kHz) | ✓ 通过 |
| | 带通滤波 (200Hz-8kHz) | ✓ 通过 |
| | 低音增强 (+10dB) | ✓ 通过 |
| | 高音衰减 (-10dB) | ✓ 通过 |
| **噪声** | 白噪声 (低) | ✓ 通过 |
| | 白噪声 (高) | ✓ 通过 |
| | 粉红噪声 | ✓ 通过 |
| **相位** | 相位反转 (180°) | ✓ 通过 |
| | Phaser 效果 | ✓ 通过 |
| **重采样** | 48kHz → 22.05kHz | ✓ 通过 |
| | 48kHz → 44.1kHz | ✓ 通过 |
| | 48kHz → 96kHz | ✓ 通过 |
| **变速** | 0.95x (-5%) | ✗ **失败** |
| | 1.05x (+5%) | ✗ **失败** |
| | 0.90x (-10%) | ✗ **失败** |
| | 1.10x (+10%) | ✗ **失败** |
| **变调** | -5% (pitch down) | ✗ **失败** |
| | +5% (pitch up) | ✗ **失败** |
| | -10% (pitch down) | ✗ **失败** |
| | +10% (pitch up) | ✗ **失败** |

### 8.2 统计

- **通过**: 22/30 (73%)
- **失败**: 8/30 (27%)

### 8.3 结论

水印对以下变换**具有鲁棒性**：
- 位深转换、重采样
- 动态处理（压缩、限制）
- EQ 均衡器
- 回声/混响
- 噪声叠加
- 相位处理
- 时间裁剪

水印对以下变换**不具有鲁棒性**：
- 变速 (time stretching)
- 变调 (pitch shifting)

> **注意**: 变速/变调是扩频水印的已知弱点。时间或频率偏移会破坏扩频码的同步检测。

### 8.4 变速/变调逆向恢复测试

变速/变调并不破坏水印数据，只是使同步检测失效。如果知道变换参数，可以逆向恢复检测：

| 原始文件 | 变换 | 原始检测 | 逆向处理 | 恢复后检测 |
|----------|------|----------|----------|------------|
| speed_110.wav | +10% 加速 | ✗ 失败 | ×0.909 减速 | ✓ **通过** |
| speed_90.wav | -10% 减速 | ✗ 失败 | ×1.111 加速 | ✓ **通过** |
| pitch_up10.wav | +10% 升调 | ✗ 失败 | ×0.909 降调 | ✓ **通过** |
| pitch_down10.wav | -10% 降调 | ✗ 失败 | ×1.111 升调 | ✓ **通过** |

**恢复率**: 4/4 (100%)

**结论**:
- 变速/变调不破坏水印，只是使检测失效
- 如果能估计变换参数，可通过逆向处理恢复检测
- 可实现"暴力搜索"：尝试 0.8x~1.2x 范围内的速度/音高因子逐个检测

### 8.5 不同变调方式对比

测试两种变调实现方式：

| 变调方式 | 原理 | 时长变化 |
|----------|------|----------|
| rubberband | 相位声码器 (保持时长) | 不变 |
| asetrate | 改变采样率 (时长同步变化) | 变化 |

**时长对比 (原始 238.75s)**:

| 文件 | 时长 |
|------|------|
| pitch_up10.wav (rubberband +10%) | 238.75s |
| pitch_asetrate_up10.wav (asetrate +10%) | 217.05s |

**检测结果**:

| 变调方式 | 变换 | 直接检测 | 逆向恢复 |
|----------|------|----------|----------|
| rubberband | +10% 升调 | ✗ 失败 | ✓ 通过 |
| rubberband | -10% 降调 | ✗ 失败 | ✓ 通过 |
| asetrate | +10% 升调 | ✗ 失败 | ✓ 通过 |
| asetrate | -10% 降调 | ✗ 失败 | ✓ 通过 |

**恢复率**: 6/6 (100%)

**结论**:
- 两种变调方式都会破坏水印检测
- 两种变调方式都能通过逆向恢复检测
- 扩频水印对**频率偏移**敏感，与时长是否变化无关
- 重采样 (22k/44k/96k) 不影响检测，因为频率内容不变

---

## 9. 复合变换测试

测试多种音频处理组合对水印的影响。

### 9.1 测试结果

| # | 组合 | 结果 |
|---|------|------|
| **常见传播链路** | | |
| 1 | 重采样 44k → AAC 128k | ✓ 通过 |
| 2 | AAC 64k | ✓ 通过 |
| 3 | EQ 低切 200Hz + AAC 128k | ✓ 通过 |
| **多次转码** | | |
| 4 | AAC 128k × 3 次 | ✓ 通过 |
| 5 | AAC → MP3 → AAC | ✓ 通过 |
| **剪辑模拟** | | |
| 6 | 裁剪 60s + EQ + 响度归一化 | ✓ 通过 |
| 7 | 叠加钢琴 1:1 + AAC 128k | ✓ 通过 |
| **攻击场景** | | |
| 8 | 变速 +5% → 恢复 → AAC 128k | ✓ 通过 |
| 9 | 噪声 + EQ 带通 + AAC 64k | ✓ 通过 |
| 10 | 回声 + 压缩器 + AAC 128k | ✓ 通过 |
| **极端测试** | | |
| 11 | 叠加 1:2 + 22kHz + AAC 64k | ✓ 通过 |
| 12 | 22kHz + AAC 64k | ✓ 通过 |

### 9.2 统计

- **通过**: 12/12 (100%)
- **失败**: 0/12 (0%)

### 9.3 结论

水印对复合变换具有极强鲁棒性：
- 多次转码 (AAC×3, AAC→MP3→AAC) 不影响检测
- 变速往返后再压缩仍可检测
- 极端质量下降 (22kHz + AAC 64k) 仍可检测
- 多重处理叠加 (叠加+重采样+压缩) 仍可检测

---

## 推荐配置

| 场景 | strength | 置信度 | SNR | 说明 |
|------|----------|--------|-----|------|
| 追求音质 | 8 | 0.76 | 42.8 dB | 最小可听影响 |
| **平衡 (默认)** | **10** | **0.96** | **40.8 dB** | **推荐** |
| 追求鲁棒 | 12 | 1.14 | 39.3 dB | 适合多次转码 |
| 极端环境 | 15+ | >1.3 | <38 dB | 低码率/多次压缩 |

---

## 指标说明

- **置信度 (Confidence)**: audiowmark 检测的 sync 分数
  - \>0.5 可靠
  - \>0.7 良好
  - \>1.0 极强
- **SNR (信噪比)**: 原始音频与水印音频的信噪比
  - \>40dB 优秀
  - \>35dB 良好
  - \>30dB 可接受
